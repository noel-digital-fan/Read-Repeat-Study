<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:local="clr-namespace:Read_Repeat_Study.Classes"
    x:Class="Read_Repeat_Study.Pages.FlagsPage"
    x:Name="FlagsPageRoot"
    Title="Flags"
    BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource OffBlack}}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <local:ColorFromNameConverter x:Key="ColorFromNameConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <AbsoluteLayout>

        <!-- Main area: Add button + flags list -->
        <VerticalStackLayout
            Padding="16"
            Spacing="12"
            AbsoluteLayout.LayoutBounds="0,0,1,1"
            AbsoluteLayout.LayoutFlags="All">

            <Button Text="Add Flag"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    CornerRadius="8"
                    Clicked="OnAddFlagClicked" />

            <CollectionView x:Name="FlagsCollection"
                            ItemsSource="{Binding FlagsCollectionItems}"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border Padding="10"
                               Margin="0,4"
                               Stroke="{AppThemeBinding Light=LightGray, Dark={StaticResource Gray600}}"
                               StrokeThickness="1"
                               BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray950}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="4" />
                            </Border.StrokeShape>
                            <Border.Triggers>
                                <DataTrigger TargetType="Border"
                                             Binding="{Binding IsSelected}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=LightGray, Dark={StaticResource Gray800}}" />
                                </DataTrigger>
                            </Border.Triggers>

                            <!-- Tap toggles or navigates -->
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={x:Reference FlagsPageRoot}, Path=FlagTappedCommand}"
                                    CommandParameter="{Binding ID}" />
                            </Border.GestureRecognizers>

                            <!-- Long-press enters multi-select -->
                            <Border.Behaviors>
                                <toolkit:TouchBehavior
                                    LongPressCommand="{Binding Source={x:Reference FlagsPageRoot}, Path=FlagLongPressedCommand}"
                                    LongPressCommandParameter="{Binding ID}"
                                    LongPressDuration="500"
                                    PressedOpacity="0.5" />
                            </Border.Behaviors>

                            <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                                <BoxView WidthRequest="30"
                                         HeightRequest="30"
                                         Color="{Binding Color, Converter={StaticResource ColorFromNameConverter}}" />
                                <Label Text="{Binding Name}" 
                                       VerticalOptions="Center"
                                       TextColor="{AppThemeBinding Light=Black, Dark=White}" />
                            </HorizontalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>

        <!-- BoxView blocker BEHIND the SelectionBar -->
        <BoxView
            x:Name="InputBlocker"
            AbsoluteLayout.LayoutBounds="0,1,1,60"
            AbsoluteLayout.LayoutFlags="WidthProportional,PositionProportional"
            BackgroundColor="Transparent"
            InputTransparent="False"
            IsVisible="False">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBlockerTapped" />
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- Fixed bottom toolbar for selection actions -->
        <HorizontalStackLayout
            x:Name="SelectionBar"
            AbsoluteLayout.LayoutBounds="0,1,1,60"
            AbsoluteLayout.LayoutFlags="WidthProportional,PositionProportional"
            Padding="12"
            Spacing="12"
            BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource OffBlack}}"
            IsVisible="False">

            <Button x:Name="EditButton"
                    Text="Edit"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    CornerRadius="8"
                    Clicked="OnEditSelected"
                    IsVisible="False"
                    HorizontalOptions="Start" />

            <Button x:Name="DeleteButton"
                    Text="Delete"
                    BackgroundColor="#ef4444"
                    TextColor="White"
                    CornerRadius="8"
                    Clicked="OnDeleteSelected"
                    IsVisible="False"
                    HorizontalOptions="Center" />

            <Button Text="Select All"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    CornerRadius="8"
                    Clicked="OnSelectAll"
                    HorizontalOptions="End" />

            <Button Text="Cancel"
                    BackgroundColor="#9E9E9E"
                    TextColor="White"
                    CornerRadius="8"
                    Clicked="OnCancelSelection"
                    HorizontalOptions="End" />

        </HorizontalStackLayout>

    </AbsoluteLayout>
</ContentPage>
