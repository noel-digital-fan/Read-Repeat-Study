<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:local="clr-namespace:Read_Repeat_Study.Classes"
    x:Class="Read_Repeat_Study.Pages.HomePage"
    x:Name="HomePageRoot"
    Title="Home">
    <ContentPage.Resources>
        <ResourceDictionary>
            <local:MathConverter x:Key="MathConverter" />
            <local:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <local:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <AbsoluteLayout>

        <!-- Main Content Grid -->
        <Grid
            AbsoluteLayout.LayoutBounds="0,0,1,1"
            AbsoluteLayout.LayoutFlags="All"
            RowDefinitions="Auto,Auto,*,Auto"
            Padding="16"
            RowSpacing="12">

            <!-- Grid.Row="0" - Export Report Button at Top Right -->
            <HorizontalStackLayout Grid.Row="0" HorizontalOptions="Start" Margin="0,0,0,8">
                <Button Text="Export Report"
                        Clicked="OnExportReportClicked"
                        BackgroundColor="Orange"
                        TextColor="White"
                        CornerRadius="8"
                        WidthRequest="130"
                        FontSize="14"
                        FontAttributes="Bold" />
            </HorizontalStackLayout>

            <!-- Grid.Row="1" - Documents Header -->
            <Label Grid.Row="1"
                   Text="Your Documents"
                   FontSize="20"
                   FontAttributes="Bold"
                   TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                   Margin="0,8,0,0"/>

            <!-- Grid.Row="2" - Documents Collection -->
            <CollectionView x:Name="DocumentsCollection"
                            Grid.Row="2"
                            ItemsSource="{Binding Documents}"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="12"
                               Margin="0,4"
                               BorderColor="{AppThemeBinding Light=LightGray, Dark={StaticResource Gray600}}"
                               CornerRadius="8"
                               HasShadow="False"
                               BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray950}}"
                               Loaded="OnDocumentFrameLoaded">
                            <Frame.Triggers>
                                <DataTrigger TargetType="Frame"
                                             Binding="{Binding IsSelected}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=LightGray, Dark={StaticResource Gray800}}" />
                                </DataTrigger>
                            </Frame.Triggers>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnDocumentTapped"
                                                      CommandParameter="{Binding}" />
                            </Frame.GestureRecognizers>
                            <Grid ColumnDefinitions="Auto,*,Auto"
                                  RowDefinitions="25,25,15"
                                  ColumnSpacing="12"
                                  HeightRequest="65">
                                <BoxView x:Name="FlagColorBox"
                                         Grid.Column="0"
                                         Grid.RowSpan="3"
                                         WidthRequest="4"
                                         VerticalOptions="Fill"
                                         BackgroundColor="Transparent"/>
                                <VerticalStackLayout Grid.Column="1" Grid.Row="0" Grid.RowSpan="3" Spacing="2">
                                    <Label Text="{Binding Name}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=Black, Dark=White}"/>
                                    <Label Text="{Binding ImportedDate, StringFormat='Imported: {0:MMM dd, yyyy HH:mm}'}"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light=Gray, Dark={StaticResource Gray400}}"/>
                                    <Label FontSize="11" TextColor="{StaticResource Primary}" FontAttributes="Italic">
                                        <Label.Text>
                                            <MultiBinding StringFormat="Currently on page: {0}">
                                                <Binding Path="LastPageIndex" Converter="{StaticResource MathConverter}" />
                                            </MultiBinding>
                                        </Label.Text>
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding LastPageIndex}" Value="{x:Null}">
                                                <Setter Property="Text" Value="No reading progress" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>
                                </VerticalStackLayout>
                                <Label Grid.Column="2"
                                       Grid.RowSpan="3"
                                       Text="{Binding Flag.Name}"
                                       HorizontalTextAlignment="Center"
                                       VerticalTextAlignment="Center"
                                       FontSize="13"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center"
                                       TextColor="{StaticResource Primary}"/>
                            </Grid>
                            <Frame.Behaviors>
                                <toolkit:TouchBehavior
                                    LongPressCommand="{Binding Source={x:Reference HomePageRoot}, Path=DocumentLongPressedCommand}"
                                    LongPressCommandParameter="{Binding .}"
                                    LongPressDuration="500"
                                    PressedOpacity="0.5" />
                            </Frame.Behaviors>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="16">
                        <Label Text="?" FontSize="48" HorizontalOptions="Center" TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"/>
                        <Label Text="No documents imported yet"
                               FontSize="16"
                               HorizontalOptions="Center"
                               TextColor="{AppThemeBinding Light=Gray, Dark={StaticResource Gray400}}"/>
                        <Label Text="Use the buttons below to get started"
                               FontSize="14"
                               HorizontalOptions="Center"
                               TextColor="{AppThemeBinding Light=Gray, Dark={StaticResource Gray400}}"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>

            <!-- Grid.Row="3" - Import and Create Buttons at Bottom -->
            <HorizontalStackLayout Grid.Row="3" HorizontalOptions="Center" Spacing="12" Margin="0,12,0,0">
                <Button Text="Import Files"
                        Clicked="OnImportFilesClicked"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        CornerRadius="8"
                        WidthRequest="140"
                        FontSize="14"
                        FontAttributes="Bold" />
                
                <Button Text="Create File"
                        Clicked="OnCreateDocumentClicked"
                        BackgroundColor="Green"
                        TextColor="White"
                        CornerRadius="8"
                        WidthRequest="140"
                        FontSize="14"
                        FontAttributes="Bold" />
            </HorizontalStackLayout>

        </Grid>

        <!-- Dynamic Dark Mode Toggle - Top Right -->
        <Frame x:Name="ThemeToggleFrame"
               AbsoluteLayout.LayoutBounds="1,0,90,40"
               AbsoluteLayout.LayoutFlags="PositionProportional"
               BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
               BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
               CornerRadius="20"
               Padding="6,4"
               HasShadow="False"
               Margin="8,8,8,0">
            <HorizontalStackLayout x:Name="ThemeToggleLayout" Spacing="4" VerticalOptions="Center" HorizontalOptions="Center">
                <Image x:Name="DarkDayModeImageSwitch"
                       Source="darkmode.png"
                       WidthRequest="16"
                       HeightRequest="16"
                       VerticalOptions="Center"
                       Opacity="0.6" />
                <Switch x:Name="ThemeSwitch" 
                        Toggled="OnThemeToggled"
                        OnColor="{StaticResource Primary}"
                        ThumbColor="White"
                        VerticalOptions="Center"
                        Scale="0.7" />
            </HorizontalStackLayout>
        </Frame>

        <BoxView x:Name="InputBlocker"
                 AbsoluteLayout.LayoutBounds="0,1,1,0.1"
                 AbsoluteLayout.LayoutFlags="All"
                 InputTransparent="False"
                 IsVisible="False"
                 BackgroundColor="Transparent">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBlockerTapped" />
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- Bottom Action Toolbar -->
        <Grid x:Name="ActionButtonsContainer"
              AbsoluteLayout.LayoutBounds="0,1,1,70"
              AbsoluteLayout.LayoutFlags="WidthProportional,PositionProportional"
              Padding="12"
              ColumnSpacing="12"
              InputTransparent="False"
              ColumnDefinitions="*,auto,auto,auto"
              BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource OffBlack}}"
              IsVisible="False">

            <Button x:Name="EditDocumentButton"
                    Grid.Column="0"
                    Text="Edit"
                    Clicked="OnEditDocumentClicked"
                    IsVisible="false" />

            <Button x:Name="SelectAllButton"
                    Grid.Column="1"
                    Text="Select All"
                    Clicked="OnSelectAllClicked"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    CornerRadius="8" />

            <Button x:Name="CancelSelectionButton"
                    Grid.Column="2"
                    Text="Unselect All"
                    Clicked="OnCancelSelectionClicked"
                    BackgroundColor="#9E9E9E"
                    TextColor="White"
                    CornerRadius="8" />

            <Button x:Name="TakeActionsButton"
                    Grid.Column="3"
                    Text="Take Actions"
                    Clicked="OnTakeActionsClicked"
                    BackgroundColor="{StaticResource Tertiary}"
                    TextColor="White"
                    CornerRadius="8" />
        </Grid>
    </AbsoluteLayout>
</ContentPage>