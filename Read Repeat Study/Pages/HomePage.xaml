<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:local="clr-namespace:Read_Repeat_Study.Classes"
    x:Class="Read_Repeat_Study.Pages.HomePage"
    x:Name="HomePageRoot"
    Title="Home">

    <!-- Add this to your ContentPage resources -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <local:MathConverter x:Key="MathConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <AbsoluteLayout>

        <!-- Main Content Grid -->
        <Grid
            AbsoluteLayout.LayoutBounds="0,0,1,1"
            AbsoluteLayout.LayoutFlags="All"
            RowDefinitions="Auto,Auto,*"
            Padding="16"
            RowSpacing="12">

            <!-- Import Button -->
            <HorizontalStackLayout Grid.Row="0" HorizontalOptions="Center" Spacing="12">
                <Button Text="Import Text Files"
                        Clicked="OnImportFilesClicked"
                        BackgroundColor="#6200EE"
                        TextColor="White"
                        CornerRadius="8"
                        WidthRequest="200" />
            </HorizontalStackLayout>

            <!-- Documents Header -->
            <Label Grid.Row="1"
                   Text="Documents"
                   FontSize="20"
                   FontAttributes="Bold"
                   Margin="0,8,0,0"/>

            <!-- Documents Collection -->
            <CollectionView x:Name="DocumentsCollection"
                            Grid.Row="2"
                            ItemsSource="{Binding Documents}"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="12"
                               Margin="0,4"
                               BorderColor="LightGray"
                               CornerRadius="8"
                               HasShadow="False"
                               BackgroundColor="White"
                               Loaded="OnDocumentFrameLoaded">
                            <Frame.Triggers>
                                <DataTrigger TargetType="Frame"
                                             Binding="{Binding IsSelected}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="LightGray" />
                                </DataTrigger>
                            </Frame.Triggers>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnDocumentTapped"
                                                      CommandParameter="{Binding}" />
                            </Frame.GestureRecognizers>
                            <Grid ColumnDefinitions="Auto,*,Auto"
                                  RowDefinitions="25,25,15"
                                  ColumnSpacing="12"
                                  HeightRequest="65">
                                <BoxView x:Name="FlagColorBox"
                                         Grid.Column="0"
                                         Grid.RowSpan="3"
                                         WidthRequest="4"
                                         VerticalOptions="Fill"
                                         BackgroundColor="Transparent"/>
                                <VerticalStackLayout Grid.Column="1" Grid.Row="0" Grid.RowSpan="3" Spacing="2">
                                    <Label Text="{Binding Name}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="Black"/>
                                    <Label Text="{Binding ImportedDate, StringFormat='Imported: {0:MMM dd, yyyy HH:mm}'}"
                                           FontSize="12"
                                           TextColor="Gray"/>
                                    <Label FontSize="11" TextColor="#6200EE" FontAttributes="Italic">
                                        <Label.Text>
                                            <MultiBinding StringFormat="Currently on page: {0}">
                                                <Binding Path="LastPageIndex" Converter="{StaticResource MathConverter}" />
                                            </MultiBinding>
                                        </Label.Text>
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding LastPageIndex}" Value="{x:Null}">
                                                <Setter Property="Text" Value="No reading progress" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>
                                </VerticalStackLayout>
                                <Label Grid.Column="2"
                                       Grid.RowSpan="3"
                                       Text="{Binding Flag.Name}"
                                       HorizontalTextAlignment="Center"
                                       VerticalTextAlignment="Center"
                                       FontSize="13"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center"
                                       TextColor="#6200EE"/>
                            </Grid>
                            <Frame.Behaviors>
                                <toolkit:TouchBehavior
                                    LongPressCommand="{Binding Source={x:Reference HomePageRoot}, Path=DocumentLongPressedCommand}"
                                    LongPressCommandParameter="{Binding .}"
                                    LongPressDuration="500"
                                    PressedOpacity="0.5" />
                            </Frame.Behaviors>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="16">
                        <Label Text="ðŸ“„" FontSize="48" HorizontalOptions="Center"/>
                        <Label Text="No documents imported yet"
                               FontSize="16"
                               HorizontalOptions="Center"
                               TextColor="Gray"/>
                        <Label Text="Tap 'Import Text Files' to get started"
                               FontSize="14"
                               HorizontalOptions="Center"
                               TextColor="Gray"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>

        </Grid>

        <!-- Floating Create Document Button -->
        <Button AbsoluteLayout.LayoutBounds="1,1,70,70"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                Text="ï¼‹"
                BackgroundColor="#2E7D32"
                TextColor="White"
                FontSize="32"
                CornerRadius="35"
                Padding="0"
                Clicked="OnCreateDocumentClicked" />

        <BoxView
    x:Name="InputBlocker"
    AbsoluteLayout.LayoutBounds="0,1,1,0.1"
    AbsoluteLayout.LayoutFlags="All"
    InputTransparent="False"
    IsVisible="False"
            BackgroundColor="Transparent">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBlockerTapped" />
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- Bottom Action Toolbar -->
        <Grid x:Name="ActionButtonsContainer"
              AbsoluteLayout.LayoutBounds="0,1,1,70"
              AbsoluteLayout.LayoutFlags="WidthProportional,PositionProportional"
              Padding="12"
              ColumnSpacing="12"
              InputTransparent="False"
              ColumnDefinitions="*,auto,auto,auto"
              IsVisible="False">

            <Button x:Name="EditDocumentButton"
                    Grid.Column="0"
                    Text="Edit"
                    Clicked="OnEditDocumentClicked"
                    IsVisible="false" />

            <Button x:Name="SelectAllButton"
                    Grid.Column="1"
                    Text="Select All"
                    Clicked="OnSelectAllClicked"
                    BackgroundColor="#2196F3"
                    TextColor="White"
                    CornerRadius="8" />

            <Button x:Name="CancelSelectionButton"
                    Grid.Column="2"
                    Text="Unselect All"
                    Clicked="OnCancelSelectionClicked"
                    BackgroundColor="#9E9E9E"
                    TextColor="White"
                    CornerRadius="8" />

            <Button x:Name="TakeActionsButton"
                    Grid.Column="3"
                    Text="Take Actions"
                    Clicked="OnTakeActionsClicked"
                    BackgroundColor="#333"
                    TextColor="White"
                    CornerRadius="8" />
        </Grid>
    </AbsoluteLayout>
</ContentPage>
